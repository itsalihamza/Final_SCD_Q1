version: '3.8'

services:
  auth-service:
    image: ${DOCKER_USERNAME:-yourusername}/healthcare-auth-service:latest
    build:
      context: ./auth-service
      dockerfile: Dockerfile
    container_name: auth-service
    networks:
      - microservices-network
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:4001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped

  patient-service:
    image: ${DOCKER_USERNAME:-yourusername}/healthcare-patient-service:latest
    build:
      context: ./patient-service
      dockerfile: Dockerfile
    container_name: patient-service
    networks:
      - microservices-network
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:4002/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped

  doctor-service:
    image: ${DOCKER_USERNAME:-yourusername}/healthcare-doctor-service:latest
    build:
      context: ./doctor-service
      dockerfile: Dockerfile
    container_name: doctor-service
    networks:
      - microservices-network
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:4003/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped

  appointment-service:
    image: ${DOCKER_USERNAME:-yourusername}/healthcare-appointment-service:latest
    build:
      context: ./appointment-service
      dockerfile: Dockerfile
    container_name: appointment-service
    networks:
      - microservices-network
    depends_on:
      notification-service:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:4004/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped

  
  notification-service:
    image: ${DOCKER_USERNAME:-yourusername}/healthcare-notification-service:latest
    build:
      context: ./notification-service
      dockerfile: Dockerfile
    container_name: notification-service
    networks:
      - microservices-network
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:4005/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped

  # ONLY service exposed to host
  api-gateway:
    image: ${DOCKER_USERNAME:-yourusername}/healthcare-api-gateway:latest
    build:
      context: ./api-gateway
      dockerfile: Dockerfile
    container_name: api-gateway
    ports:
      - "4000:4000"  
    networks:
      - microservices-network
    depends_on:
      auth-service:
        condition: service_healthy
      patient-service:
        condition: service_healthy
      doctor-service:
        condition: service_healthy
      appointment-service:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:4000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped

networks:
  microservices-network:
    driver: bridge
    name: healthcare-network
